<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="./styles/home.button.css">
    <link rel="stylesheet" href="./styles/home.general.css">
    <link rel="stylesheet" href="./styles/home.notification.css">
    
    <title>ARbiter</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>
  </head>

  <body>
    <div class="notification" id="notification">Your position has been updated!</div>
    <div class="ui-container">
      <div class="ui-button-container">
        <button class="ui-button" onclick="window.location.href = '/page'">
          <img src="/static/images/icons/home_icon.jpg" alt="Home" className="home-icon" />
        </button>        
      </div>
      </div>

      <a-scene arjs embedded renderer="logarithmicDepthBuffer: true;" vr-mode-ui="enabled: false" gesture-detector id="scene">

      <!-- object 1 entrance cube -->
      <a-marker type="pattern" raycaster="objects: .clickable"
      emitevents="true"
      cursor="fuse: false; rayOrigin: mouse;" url="./tags/patt/pattern-tag25h9-5.patt" id="entrance">
        <a-box position="0 1 0" rotation="0 0 0" width="0.001" height="0.001" depth="0.5" id="rotating-box" gesture-handler>
          <!-- right positions-->
          <a-plane position="-1 0 0" width="2" height="2" src="#entrance3" rotation="0 90 -90" scale="-1 1 1"  material="side: double;" class="clickable"></a-plane> <!-- needed-->
          <a-plane position="1 0 0" width="2" height="2" src="#entrance4" rotation="0 90 -90" material="side: double;" class="clickable"></a-plane> <!-- needed-->
          <a-plane position="0 1 0" width="2" height="2" src="#entrance5" rotation="-90 0 0" material="side: double;" class="clickable"></a-plane> <!-- needed-->

          <!-- plain sides-->
          <a-plane position="0 0 1" width="2" height="2" rotation="0 0 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
          <a-plane position="0 0 -1" width="2" height="2" rotation="0 180 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
          <a-plane position="0 -1 0" width="2" height="2" rotation="90 0 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
        </a-box>
      </a-marker>


      <!-- object 2 student support -->
      <a-marker type="pattern" raycaster="objects: .clickable"
      emitevents="true"
      cursor="fuse: false; rayOrigin: mouse;" url="./tags/patt/pattern-tag25h9-6.patt" id="ssupport">
        <a-box position="0 1 0" rotation="0 0 0" width="0.001" height="0.001" depth="0.5" id="rotating-box" gesture-handler>
<a-plane position="-1 0 0" width="2" height="2" src="#stud3" rotation="0 90 -90" scale="-1 1 1"  material="side: double;" class="clickable"></a-plane>
<a-plane position="1 0 0" width="2" height="2" src="#stud4" rotation="0 90 -90" material="side: double;" class="clickable"></a-plane>
<a-plane position="0 1 0" width="2" height="2" src="#stud5" rotation="-90 0 0" material="side: double;" class="clickable"></a-plane>

<!-- plain sides-->
<a-plane position="0 0 1" width="2" height="2" rotation="0 0 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
<a-plane position="0 0 -1" width="2" height="2" rotation="0 180 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
<a-plane position="0 -1 0" width="2" height="2" rotation="90 0 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
        </a-box>
      </a-marker>

      <!-- object 3 library -->
      <a-marker type="pattern" raycaster="objects: .clickable"
      emitevents="true"
      cursor="fuse: false; rayOrigin: mouse;" url="./tags/patt/pattern-tag25h9-3.patt" id="library">
        <a-box position="0 1 0" rotation="0 0 0" width="0.001" height="0.001" depth="0.5" id="rotating-box" gesture-handler>
          <a-plane position="-1 0 0" width="2" height="2" src="#lib3" rotation="0 90 -90" scale="-1 1 1" material="side: double;" class="clickable"></a-plane>
          <a-plane position="1 0 0" width="2" height="2" src="#lib4" rotation="0 90 -90" material="side: double;" class="clickable"></a-plane>
          <a-plane position="0 1 0" width="2" height="2" src="#lib5" rotation="-90 0 0" material="side: double;" class="clickable"></a-plane>

          <!-- plain sides-->
          <a-plane position="0 0 1" width="2" height="2" rotation="0 0 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
          <a-plane position="0 0 -1" width="2" height="2" rotation="0 180 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
          <a-plane position="0 -1 0" width="2" height="2" rotation="90 0 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
        </a-box>
      </a-marker>

      <!-- object 4 cafe -->
      <a-marker type="pattern" raycaster="objects: .clickable"
      emitevents="true"
      cursor="fuse: false; rayOrigin: mouse;" url="./tags/patt/pattern-tag25h9-10.patt" id="cafe">
        <a-box position="0 1 0" rotation="0 0 0" width="0.001" height="0.001" depth="0.5" id="rotating-box" gesture-handler>
<a-plane position="-1 0 0" width="2" height="2" src="#cafe3" rotation="0 90 -90" scale="-1 1 1" material="side: double;" class="clickable"></a-plane>
<a-plane position="1 0 0" width="2" height="2" src="#cafe4" rotation="0 90 -90" material="side: double;" class="clickable"></a-plane>
<a-plane position="0 1 0" width="2" height="2" src="#cafe5" rotation="-90 0 0" material="side: double;" class="clickable"></a-plane>

<!-- plain sides-->
<a-plane position="0 0 1" width="2" height="2" rotation="0 0 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
<a-plane position="0 0 -1" width="2" height="2" rotation="0 180 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
<a-plane position="0 -1 0" width="2" height="2" rotation="90 0 0" material="side: double; color: #5B56B7;" class="clickable"></a-plane>
        </a-box>
      </a-marker>
    
      <a-entity camera></a-entity>

     <!--Map (first floor)-->
<a-marker type="pattern" raycaster="objects: .clickable"
emitevents="true"
cursor="fuse: false; rayOrigin: mouse;" url="./tags/patt/pattern-tag25h9-4.patt" id="marker-map">
  <a-entity id="platform" position="0 0 0">
    <a-plane position="0 0 0" width="5" height="5" rotation="-90 0 0" src="#firstFloor" material="shader: flat; opacity: 0.9;">
    </a-plane>
  </a-entity>
</a-marker>

<!--Map (ground floor)-->
<a-marker type="pattern" raycaster="objects: .clickable"
emitevents="true"
cursor="fuse: false; rayOrigin: mouse;" url="./tags/patt/pattern-tag25h9-8.patt" id="marker-map-ground">
  <a-entity id="platform" position="0 0 0">
    <a-plane position="0 0 0" width="5" height="5" rotation="-90 0 0" src="#groundFloor" material="shader: flat; opacity: 0.9;">
    </a-plane>
  </a-entity>
</a-marker>

<a-assets>
        <!-- map-->
        <img id="firstFloor" src="../static/first_floor.png">
        <img id="groundFloor" src="../static/ground_floor.png">
        <!--entrance-->
        <img id="entrance3" src="./tags/pos_photos/entrance/entrance_desc.png">
        <img id="entrance4" src="./tags/pos_photos/entrance/entrance_direct.png">
        <img id="entrance5" src="./tags/pos_photos/entrance/entrance.png">
        <!--stud support-->
        <img id="stud3" src="./tags/pos_photos/student_support/stud_desc.png">
        <img id="stud4" src="./tags/pos_photos/student_support/stud_dir.png">
        <img id="stud5" src="./tags/pos_photos/student_support/student_support.png">
        <!--library-->
        <img id="lib3" src="./tags/pos_photos/library/lib_desc.png">
        <img id="lib4" src="./tags/pos_photos/library/lib_dir.png">
        <img id="lib5" src="./tags/pos_photos/library/library.png">
        <!--cafe-->
        <img id="cafe3" src="./tags/pos_photos/cafe/cafe_description.png">
        <img id="cafe4" src="./tags/pos_photos/cafe/cafe_directions.png">
        <img id="cafe5" src="./tags/pos_photos/cafe/cafe.png">
</a-assets>
    </a-scene>
    
<script>
// init
const markerObjects = new Map();
window.THREE = AFRAME.THREE;

// doms variables
const studentSupport = document.querySelector('#ssupport');
const cafe = document.querySelector('#cafe');
const library = document.querySelector('#library');
const entrance = document.querySelector('#entrance');


let robotPosition = {x: 0, y: 100, z: 0};

function updateRobotPosition(newPosition, floor) {
  if (robotPosition.x === newPosition.x && robotPosition.y === newPosition.y && robotPosition.z === newPosition.z) {
        console.log("Same marker, no update needed.");
        return;
    }
    robotPosition = newPosition;
    console.log(`Moved to: x=${robotPosition.x}, y=${robotPosition.y}, z=${robotPosition.z}`);

    let notification = document.getElementById('notification');
    notification.classList.add('show');

    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}


function showRobotOnMap(marker) {
    console.log('marker map found');
    const objects = markerObjects.get(marker) || {};
    if (objects.pip) {
        marker.object3D.remove(objects.pip);
    }
    
    const mtlLoader = new THREE.MTLLoader();
    mtlLoader.load('../static/models/Robot_Holo_5.mtl', function(materials) {
        materials.preload();
        const objLoader = new THREE.OBJLoader();
        objLoader.setMaterials(materials);
        objLoader.load('../static/models/Robot_Holo_5.obj', function(object) {
            object.scale.set(0.005, 0.005, 0.005);
            object.position.set(robotPosition.x, robotPosition.y, robotPosition.z);
            marker.object3D.add(object);
            objects.pip = object;
            markerObjects.set(marker, objects);
            console.log(`Robot pos: x=${robotPosition.x}, y=${robotPosition.y}, z=${robotPosition.z}`);

            animateRobotPulse(object);
            styleRobotAppearance(object);
        });
    });
}

function animateRobotPulse(robot) {
    let scaleUp = true;

    robot.traverse((child) => {
        if (child.isMesh) {
            child.material.color.set(0x007BFF); 
            child.material.emissive.set(0x007BFF);
            child.material.emissiveIntensity = 0.5;
        }
    });

    function pulse() {
        if (scaleUp) {
            robot.scale.set(0.006, 0.006, 0.006);
        } else {
            robot.scale.set(0.004, 0.004, 0.004);
        }
        scaleUp = !scaleUp;
        setTimeout(() => requestAnimationFrame(pulse), 500);
    }

    pulse();
}

function checkAndShowRobot(marker) {
  const positionElement = document.getElementById('lastPosition');
    if (robotPosition.x === -0.5 && robotPosition.z === 0.5 ||  // studentSupport
        robotPosition.x === -2.1 && robotPosition.z === 0.5) {  // library
        showRobotOnMap(mapMarker, "Upper Floor");
    } 
    else if (robotPosition.x === -1.5 && robotPosition.z === 0 || // cafe
             robotPosition.x === 0 && robotPosition.z === 1.4) { // entrance
        showRobotOnMap(mapMarkerGround, "Ground Floor");
    }
}

// ssuport coord done
studentSupport.addEventListener('markerFound', () => updateRobotPosition({x: -0.5, y: 0.1, z: 0.5}));
// cafe coord done
cafe.addEventListener('markerFound', () => updateRobotPosition({x: -1.5, y: 0.1, z: 0}));
// library coord done 
library.addEventListener('markerFound', () => updateRobotPosition({x: -2.1, y: 0.1, z: 0.5}));
//entrance coord done
entrance.addEventListener('markerFound', () => updateRobotPosition({x: 0, y: 0.1, z: 1.4}));

// different maps
const mapMarker = document.querySelector('#marker-map');
const mapMarkerGround = document.querySelector('#marker-map-ground');

mapMarkerGround.addEventListener('markerFound', () => {
    checkAndShowRobot(mapMarkerGround);
});

mapMarker.addEventListener('markerFound', () => {
    checkAndShowRobot(mapMarker);
});

</script>
</body>
</html>
